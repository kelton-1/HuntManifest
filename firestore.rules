rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Get the current timestamp
    function now() {
      return request.time;
    }
    
    // Validate string field
    function isValidString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }
    
    // Validate number field
    function isValidNumber(field, min, max) {
      return field is number && field >= min && field <= max;
    }
    
    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    // ============================================
    // USER PROFILES
    // ============================================
    
    match /users/{userId} {
      // Allow users to read their own root document
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false; // Prevent accidental deletion
      
      // Profile subcollection
      match /profile/{docId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validateProfile();
        allow update: if isOwner(userId) && validateProfileUpdate();
        allow delete: if false;
        
        function validateProfile() {
          let data = request.resource.data;
          return hasRequiredFields(['hunterName', 'createdAt'])
            && isValidString(data.hunterName, 1, 100)
            && (data.experience == null || data.experience in ['first', 'intermediate', 'veteran'])
            && (data.temperatureUnit == null || data.temperatureUnit in ['F', 'C'])
            && (data.windSpeedUnit == null || data.windSpeedUnit in ['mph', 'kph']);
        }
        
        function validateProfileUpdate() {
          let data = request.resource.data;
          return isValidString(data.hunterName, 1, 100)
            && (data.experience == null || data.experience in ['first', 'intermediate', 'veteran'])
            && (data.temperatureUnit == null || data.temperatureUnit in ['F', 'C'])
            && (data.windSpeedUnit == null || data.windSpeedUnit in ['mph', 'kph']);
        }
      }
      
      // ============================================
      // INVENTORY COLLECTION
      // ============================================
      
      // ============================================
      // INVENTORY COLLECTION
      // ============================================
      
      // ============================================
      // INVENTORY COLLECTION
      // ============================================
      
      match /inventory/{itemId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validateInventoryItem();
        allow update: if isOwner(userId) && validateInventoryUpdate();
        allow delete: if isOwner(userId);
        
        function validateInventoryItem() {
          let data = request.resource.data;
          let validCategories = ['Firearm', 'Ammo', 'Waders', 'Decoy', 'Call', 'Clothing', 'Blind', 'Safety', 'Dog', 'Vehicle', 'Other'];
          let validConditions = ['New', 'Excellent', 'Good', 'Fair', 'Poor'];
          let validStatuses = ['Active', 'Archived', 'Needs Repair', 'Lost'];
          
          return hasRequiredFields(['name', 'category', 'quantity', 'createdAt'])
            && isValidString(data.name, 1, 200)
            && data.category in validCategories
            && isValidNumber(data.quantity, 0, 10000)
            && data.createdAt is timestamp
            // Optional fields validation
            && (!('brand' in data) || isValidString(data.brand, 0, 100))
            && (!('model' in data) || isValidString(data.model, 0, 100))
            && (!('notes' in data) || isValidString(data.notes, 0, 1000))
            && (!('species' in data) || isValidString(data.species, 0, 100))
            && (!('decoyType' in data) || isValidString(data.decoyType, 0, 100))
            && (!('condition' in data) || data.condition in validConditions)
            && (!('status' in data) || data.status in validStatuses)
            && (!('serialNumber' in data) || isValidString(data.serialNumber, 0, 100))
            && (!('purchaseDate' in data) || data.purchaseDate is string || data.purchaseDate is timestamp)
            && (!('purchasePrice' in data) || isValidNumber(data.purchasePrice, 0, 1000000))
            && (!('warranty' in data) || isValidString(data.warranty, 0, 200))
            && (!('tags' in data) || data.tags is list)
            && (!('isChecked' in data) || data.isChecked is bool);
        }
        
        function validateInventoryUpdate() {
          let data = request.resource.data;
          let validCategories = ['Firearm', 'Ammo', 'Waders', 'Decoy', 'Call', 'Clothing', 'Blind', 'Safety', 'Dog', 'Vehicle', 'Other'];
          let validConditions = ['New', 'Excellent', 'Good', 'Fair', 'Poor'];
          let validStatuses = ['Active', 'Archived', 'Needs Repair', 'Lost'];
          
          return isValidString(data.name, 1, 200)
            && data.category in validCategories
            && isValidNumber(data.quantity, 0, 10000)
            // Optional fields validation
            && (!('brand' in data) || isValidString(data.brand, 0, 100))
            && (!('model' in data) || isValidString(data.model, 0, 100))
            && (!('notes' in data) || isValidString(data.notes, 0, 1000))
            && (!('species' in data) || isValidString(data.species, 0, 100))
            && (!('decoyType' in data) || isValidString(data.decoyType, 0, 100))
            && (!('condition' in data) || data.condition in validConditions)
            && (!('status' in data) || data.status in validStatuses)
            && (!('serialNumber' in data) || isValidString(data.serialNumber, 0, 100))
            && (!('purchaseDate' in data) || data.purchaseDate is string || data.purchaseDate is timestamp)
            && (!('purchasePrice' in data) || isValidNumber(data.purchasePrice, 0, 1000000))
            && (!('warranty' in data) || isValidString(data.warranty, 0, 200))
            && (!('tags' in data) || data.tags is list)
            && (!('isChecked' in data) || data.isChecked is bool);
        }
      }
      
      // ============================================
      // HUNT LOGS COLLECTION
      // ============================================
      
      match /huntLogs/{logId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validateHuntLog();
        allow update: if isOwner(userId) && validateHuntLogUpdate();
        allow delete: if isOwner(userId);
        
        function validateHuntLog() {
          let data = request.resource.data;
          let validSkyConditions = ['Clear', 'Partly Cloudy', 'Overcast', 'Rain', 'Snow', 'Fog'];
          let validHuntTypes = ['Waterfowl', 'Upland', 'Turkey', 'Deer', 'Other'];
          let validResults = ['Successful', 'Unsuccessful', 'Partial'];
          
          return hasRequiredFields(['date', 'location', 'weather', 'harvests', 'createdAt'])
            && (data.date is string || data.date is timestamp)
            && data.location.keys().hasAll(['name'])
            && isValidString(data.location.name, 1, 200)
            && data.weather.keys().hasAll(['temperature', 'windSpeed', 'windDirection', 'skyCondition'])
            && isValidNumber(data.weather.temperature, -100, 150)
            && isValidNumber(data.weather.windSpeed, 0, 200)
            && data.weather.skyCondition in validSkyConditions
            && data.harvests is list
            && data.createdAt is timestamp
            // Optional fields validation
            && (!('huntType' in data) || data.huntType in validHuntTypes)
            && (!('notes' in data) || isValidString(data.notes, 0, 5000))
            && (!('photos' in data) || data.photos is list)
            && (!('result' in data) || data.result in validResults)
            && (!('startTime' in data) || isValidString(data.startTime, 0, 50))
            && (!('endTime' in data) || isValidString(data.endTime, 0, 50))
            && (!('duration' in data) || isValidNumber(data.duration, 0, 1440))
            && (!('participants' in data) || data.participants is list)
            && (!('blindType' in data) || isValidString(data.blindType, 0, 100))
            && (!('decoySpread' in data) || isValidString(data.decoySpread, 0, 1000))
            && (!('callingStrategy' in data) || isValidString(data.callingStrategy, 0, 1000))
            && (!('lessonsLearned' in data) || isValidString(data.lessonsLearned, 0, 2000))
            && (!('rating' in data) || isValidNumber(data.rating, 1, 5))
            && (!('tags' in data) || data.tags is list);
        }
        
        function validateHuntLogUpdate() {
          let data = request.resource.data;
          let validSkyConditions = ['Clear', 'Partly Cloudy', 'Overcast', 'Rain', 'Snow', 'Fog'];
          let validHuntTypes = ['Waterfowl', 'Upland', 'Turkey', 'Deer', 'Other'];
          let validResults = ['Successful', 'Unsuccessful', 'Partial'];
          
          return (data.date is string || data.date is timestamp)
            && data.location.keys().hasAll(['name'])
            && isValidString(data.location.name, 1, 200)
            && data.weather.keys().hasAll(['temperature', 'windSpeed', 'windDirection', 'skyCondition'])
            && isValidNumber(data.weather.temperature, -100, 150)
            && isValidNumber(data.weather.windSpeed, 0, 200)
            && data.weather.skyCondition in validSkyConditions
            && data.harvests is list
            // Optional fields validation
            && (!('huntType' in data) || data.huntType in validHuntTypes)
            && (!('notes' in data) || isValidString(data.notes, 0, 5000))
            && (!('photos' in data) || data.photos is list)
            && (!('result' in data) || data.result in validResults)
            && (!('startTime' in data) || isValidString(data.startTime, 0, 50))
            && (!('endTime' in data) || isValidString(data.endTime, 0, 50))
            && (!('duration' in data) || isValidNumber(data.duration, 0, 1440))
            && (!('participants' in data) || data.participants is list)
            && (!('blindType' in data) || isValidString(data.blindType, 0, 100))
            && (!('decoySpread' in data) || isValidString(data.decoySpread, 0, 1000))
            && (!('callingStrategy' in data) || isValidString(data.callingStrategy, 0, 1000))
            && (!('lessonsLearned' in data) || isValidString(data.lessonsLearned, 0, 2000))
            && (!('rating' in data) || isValidNumber(data.rating, 1, 5))
            && (!('tags' in data) || data.tags is list);
        }
      }
      
      // ============================================
      // AUDIT LOG (Future-proofing)
      // ============================================
      
      match /auditLog/{logId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false; // Audit logs are immutable
      }
      
      // ============================================
      // APP SETTINGS / PREFERENCES
      // ============================================
      
      match /settings/{settingId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // ============================================
    // APP-WIDE CONFIGURATION (Read-only for users)
    // ============================================
    
    match /appConfig/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin only via Firebase Console
    }
    
    // ============================================
    // GLOBAL SPECIES/CATEGORIES (Read-only for users)
    // ============================================
    
    match /species/{speciesId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
  }
}
